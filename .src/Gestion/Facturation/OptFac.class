' Gambas class file

Private $vfac As ObjFacB
Private $courriel As String
Private $choix As Integer
 
Public Sub _new(choix As Integer, num As String, nfac As String, Optional mttc As String, Optional livraison As Boolean, Optional dte As LDate = LDate(Now), Optional courriel As String)

  Dim chaine As Chainage
  Dim res As Result
 
  $courriel = courriel
  $choix = choix
  'gridview recherche adresse
  Colal.Columns.count = 6
  Colal.Columns[0].Width = 0
  Colal.Columns[1].Width = 80
  Colal.Columns[2].Width = 150
  Colal.Columns[3].Width = 150
  Colal.Columns[4].Expand = True
  Colal.Columns[1].Text = "Rs"
  Colal.Columns[2].Text = "Nom"
  Colal.Columns[3].Text = "Prénom"
  Colal.Columns[4].Text = "Ville"
  Colal.Columns[5].Text = "Code"
  Colal.H = padliv.ClientH
  'gridview saisie réglement
  grregl.Columns.Count = 2
  grregl.Columns[0].Text = "Mode de réglement"
  grregl.Columns[0].Alignment = Align.Center
  grregl.Columns[0].Expand = True
  grregl.Columns[1].Text = "Montant"
  grregl.Columns[1].Alignment = Align.Center
  grregl.Columns[1].Width = 80
  
  chaine = New Chainage([Nombl, Adr1BL, Adr2BL, CPBL, VilleBL])
  chaine = New Chainage([Dtef, Dtech])

  Dtef.Dat = True
  Dtech.Dat = True
  Rglt.numerique = True
  Rglt.nbdec = "2"
  totr.numerique = True
  totr.nbdec = "2"
  CPBL.reg = "[0-9]{0,5}"
  'Affiche les variables modifiables
  $vfac = New ObjFacB(nfac, choix) As "var"
  $vfac.livraison = livraison
  Dtef.Text = dte.L
  $vfac.dtedoc = dte
  
  propimp.Text = $vfac.imp.Name
  entete.Value = $vfac.entete
  If $vfac.autoent Or $vfac.ttc Then
    Impttc.Value = True
    If $vfac.autoent Then Impttc.Enabled = False
  Endif
  Reserve.Value = $vfac.reserve
  Recap.Value = $vfac.recap
  Rgmt.Value = $vfac.saisreg
  Imp2L.Value = $vfac.ligne2
  totlettre.Value = $vfac.doclet
  If Rgmt.Value And $vfac.choix = ObjFac.facture Then 
    RegDef.Visible = True
    Preg.Visible = True
    Preg.Enabled = True
  Else
    Rgmt.Enabled = False
    RegDef.Visible = False
    Preg.Visible = False
  Endif
  RegDef.Value = $vfac.breg
  Coln.Value = $vfac.colon

  Select Case $vfac.choix
    Case ObjFac.facture, ObjFac.finmois, ObjFac.archive, ObjFac.abonnement
      Pbl.Visible = False
      Pfac.Visible = True
      If $vfac.choix = ObjFac.facture Then
        Checkdte.Visible = True
        Pfac1.Visible = True
        ImpPDF.Enabled = True
      Else
        Checkdte.Visible = False
        Pfac1.Visible = False
      Endif
      If $vfac.choix = ObjFac.facture Or $vfac.choix = ObjFac.archive Then
        Rglt.Text = mttc
      Endif
    
    Case Else
      If $vfac.choix = ObjFac.bl Then
        Checkdte.Visible = True
        Dtef.Enabled = False
      Else
        Checkdte.Visible = False
      Endif
      Pbl.Visible = True
      Pfac1.Visible = False
      Pfac.Visible = False
      
  End Select
  
  regmt.Add(" ")
  res = utils.db.Exec("SELECT * FROM Fiches_Reglements")
  If res.Available Then
    Repeat
      regmt.Add(res!code & " " & res!libel)
    Until res.MoveNext()
  Endif
 
  $vfac.numcli = num
  If $vfac.choix = ObjFac.archive Then
    $vfac.numfac = nfac
  Else
    $vfac.numbl = nfac
  Endif
  If $vfac.sms And $vfac.choix <> ObjFac.finmois Then sms.Visible = True Else sms.Visible = False
  If $vfac.choix = ObjFac.finmois Then visu.Visible = False
  Me.Height -= (Preg.Height + padliv.Height)
  
End

Public Sub Form_Open()

  $vfac.numcli = $vfac.numcli

End

Public Sub form_Close()

  Start.LocalSettings["/Soc" & Start.Societe & "/Recap"] = Recap.Value
  ' Start.LocalSettings["/Soc" & Start.Societe & "/Impttc"] = Impttc.Value
  Start.LocalSettings["/Soc" & Start.Societe & "/Entete"] = Entete.Value
  Start.LocalSettings["/Soc" & Start.Societe & "/Conditions"] = Reserve.Value
  Start.LocalSettings["/Soc" & Start.Societe & "/Pied"] = Pied.Value
  Start.LocalSettings["/Soc" & Start.Societe & "/Imp2L"] = Imp2L.Value
  Start.LocalSettings["/Soc" & Start.Societe & "/Col"] = Coln.Value
 'Start.LocalSettings["/Soc" & Start.Societe & "/BlA5"] = BlA5.Value
  Start.LocalSettings["/Soc" & Start.Societe & "/Impstocke"] = Impstock.Value
  Start.LocalSettings["/Soc" & Start.Societe & "/ImpPDF"] = ImpPDF.Value
  Start.LocalSettings["/Soc" & Start.Societe & "/ImpTotbl"] = Imptotbl.value
  Start.LocalSettings["/Soc" & Start.Societe & "/Recap"] = Recap.Value
'  Start.LocalSettings["/Soc" & Start.Societe & "/Cimp"] = Cimp.text
  Start.LocalSettings["/Soc" & Start.Societe & "/Cond"] = Cond.value
  Start.LocalSettings.Save
  Start.LocalSettings.Reload

End
'Gestion des click et lostfocus
Public Sub Checkdte_Click()

  $vfac.dtmouv = Checkdte.Value

End

Public Sub Dtef_LostFocus()
  
    $vfac.dtedoc = Dtef.dte

End

Public Sub Dtech_LostFocus()

  If $vfac.dteech <> Dtech.dte Then
    $vfac.dteech = Dtech.dte
    utils.db.Exec("UPDATE Fiches_Bl SET ech=&1  WHERE numbl=&2", Dtech.dte.G, $vfac.numbl)
  Endif

End

Public Sub entete_Click()

  $vfac.entete = entete.Value

End

Public Sub Coln_Click()

  $vfac.colon = Coln.Value

End

Public Sub Cond_Click()

  $vfac.simpcond = Cond.Value

End

Public Sub Imp2L_Click()

  $vfac.ligne2 = Imp2L.Value

End


Public Sub Nbexpl_Click()

  $vfac.nbexplemplaire = Nbexpl.Text

End

Public Sub Blch_Click()

  $vfac.blchif = Blch.Value

End

Public Sub Impstock_Click()

  $vfac.Stock = Impstock.Value

End

Public Sub Impttc_Click()

  $vfac.ttc = Impttc.Value

End

Public Sub Ignore_Remise_Click()

  $vfac.remise = Ignore_Remise.Value
  If $vfac.remise Then
    Imptotbl.Value = False
    Imptotbl.Enabled = False
  Else
    Imptotbl.Enabled = True
  Endif

End

Public Sub Imptotbl_Click()
  
  $vfac.blrecap = Imptotbl.Value
  
End

Public Sub AffBledit2_Click()

  $vfac.badr = AffBledit2.Value
  If $vfac.badr Then
    padliv.Visible = True
  Else
    padliv.Visible = False
  Endif

End

Public Sub reserve_Click()

  $vfac.reserve = reserve.Value

End

Public Sub Pied_Click()

  $vfac.pied = Pied.Value

End

Public Sub Recap_Click()

  $vfac.recap = recap.Value

End

Public Sub Rgmt_Click()

  $vfac.saisreg = Rgmt.Value
  If $vfac.saisreg Then
    RegDef.Visible = True
    Preg.Visible = True
  Else
    RegDef.Visible = False
    Preg.Visible = False
  Endif

End

Public Sub RegDef_Click()

  $vfac.breg = RegDef.Value

End

Public Sub ImpPDF_Click()

  $vfac.pdf = ImpPDF.Value

End

'Evenements issues de VarFac
Public Sub var_echeance(Value As LDate)

  Dtech.Text = Value.L

End

Public Sub var_nombre(Value As String)

  Nbexpl.Text = Value

End

Public Sub var_fttc(Value As Boolean)

  Impttc.Value = Value

End


Public Sub var_modreg(value As String)

  Dim i As Integer
  
  Regmt.Text = " "
  For i = 1 To Regmt.Count - 1
    If value = Left(regmt[i].Text, 2) Then
      regmt.Text = regmt[i].Text
      Break
    Endif
  Next

End

Public Sub totlettre_Click()

  $vfac.doclet = totlettre.Value

End

'***********************************************************************************
'gestion des adresses de livraison
Public Sub ToggleButton10_Click()

  If Colal.Visible = True Then
    Colal.clear
    Colal.visible = False
  Else
    Colal.Visible = True
    Colal.Raise
    
     Aff_AdrC("")
     Colal.SetFocus
  Endif
End

Public Sub Aff_AdrC(Org As String)
  Dim AdrResult As Result
Dim champ As Boolean = False
Colal.Clear
If Org = "F2" Then
  AdrResult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabAdrC") & " order by nom", $vfac.numcl)
Else
  AdrResult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabAdrC") & " where code = &1 order by nom", $vfac.numcli)
Endif
  If AdrResult.Available Then
    Repeat
      Colal.Add(AdrResult!num, AdrResult!num)
      Colal.item[0] = AdrResult!num
      Colal.item[1] = AdrResult!rs_soc
      Colal.item[2] = AdrResult!nom
      Colal.item[3] = AdrResult!pnm
      Colal.item[4] = AdrResult!ville
      Colal.item[5] = AdrResult!code
    Until AdrResult.MoveNext()
    Colal.MoveFirst
    Repeat
      If Colal.item[5] = $vfac.numcli Then
        Champ = True
        Break
      Endif
    Until Colal.MoveNext()
    If champ Then
    Colal.item.Selected = True
    Colal.Raise
    Else
      Colal.MoveFirst
    Colal.item.Selected = True
     Colal.Raise
    Endif
  Endif

End

Public Sub Colal_Click()

  Dim rcli As Result

  rCli = Utils.db.Exec("select * from " & Cbase.Table("TabAdrC") & " where num = &1", Colal.item[0])
  If rCli.Available Then
    Nombl.Text = rcli!rs_soc & " " & rcli!nom & " " & rcli!pnm
    Nombl_LostFocus
    Adr1Bl.Text = rcli!adr1
    Adr1BL_LostFocus
    Adr2Bl.Text = rcli!adr2
    Adr2BL_LostFocus
    Cpbl.Text = rcli!cd_ptl
    CPBL_LostFocus
    VilleBl.text = rcli!ville
    VilleBL_LostFocus
    Colal.Clear
    Colal.visible = False
    Nombl.SetFocus
    Nombl.Select
  Endif

End

Public Sub Colal_Keypress()
  
  If Key.code = Key.escape Or If Key.code = Key.esc Then Colal.visible = False
  If Key.code = Key.Enter Or If Key.code = Key.Return Then 
 Colal.MoveCurrent
  Colal_Click()
  Endif
  If Key.code = Key.F2 Then
     Aff_AdrC("F2")
'    If Colal.count > 9 Then
'      Colal.H = Edit.H + padliv.H - 30
 '   Else
      Colal.H = padliv.ClientH
 '   Endif
  Endif
End


'gestion lostfocus 
Public Sub Nombl_LostFocus()

  $vfac.adrliv.nom = Nombl.Text

End

Public Sub Adr1BL_LostFocus()

  $vfac.adrliv.adr1 = Adr1BL.Text

End

Public Sub Adr2BL_LostFocus()

  $vfac.adrliv.adr2 = Adr2BL.Text

End

Public Sub CPBL_LostFocus()

  $vfac.adrliv.cp = CPBL.Text

End

Public Sub VilleBL_LostFocus()

  $vfac.adrliv.ville = VilleBL.Text

End
'*************************************************************************************
'gestion des modes de regelement
Public Sub ajout_Click()

  If Rglt.Value <> 0 Then
    grregl.Rows.Count += 1
    grregl[grregl.Rows.Max, 0].Text = Regmt.Current.Text
    grregl[grregl.Rows.Max, 0].Alignment = Align.Left
    grregl[grregl.Rows.Max, 1].Text = Rglt.Text
    grregl[grregl.Rows.Max, 1].Alignment = Align.Right
  Endif
  totr.Value = totreg()

End

Public Sub grregl_KeyPress()

  If Key.Code = Key.Delete Then
    supreg(grregl.Row)
  Endif

End

Public Sub grregl_Activate()

  Regmt.Text = grregl[grregl.Row, 0].Text
  Rglt.Text = grregl[grregl.Row, 1].Text
  supreg(grregl.Row)

End

Private Sub supreg(row As Integer)
  
  Dim i As Integer
  
  If grregl.Rows.Count = 0 Then Return
  
  grregl.Rows.Remove(row)
  grregl.Refresh
  totr.Value = totreg()
  
End

Private Function totreg() As Float
  
  Dim i As Integer
  Dim tot As Float
  
  For i = 0 To grregl.Rows.Max
    tot += Val(grregl[i, 1].Text)
  Next
  Return tot
  
End

'*****************************************************************************************
'gestion des boutons
'******************************************************************************************
'bouton édition
Public Sub edite_Click()
  
  Select Case $choix
    Case ObjFac.finmois, ObjFac.abonnement
      $vfac.editefm()
      Me.Close
    Case ObjFac.facture
      $vfac.editef()
    Case Else
      $vfac.editebl()
  End Select

End

Public Sub Fermer_Click()

  Me.Close

End

Public Sub visu_Click()

Dim num As String
Dim dt As LDate

dt = New LDate(Now)
num = $vfac.numbl
 ObjFacB(num, $choix).visualisation
  $vfac.visualisation()

End

Public Sub sms_Click()

  Dim hForm As Gsm
  Dim telp As String

  $vfac.resent.MoveFirst
  Telp = Replace$($vfac.resent!tel, ".", "")
  Telp = Replace$($vfac.resent!tel, " ", "")
  hForm = New Gsm(telp)
  hForm.Showmodal()

End

Public Sub mail_Click()

  $vfac.mail($courriel)
  
End

Public Sub propimp_Click()

  $vfac.imp.Configure
  propimp.Text = $vfac.imp.Name

End
