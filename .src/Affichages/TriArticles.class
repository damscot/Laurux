' Gambas class file

Private Dbl As Boolean = False
Private sel As String
Private Tri2Art As String
Private Bart As Boolean
Private BStock As Boolean
Private Org As String
Private NbEnreg As Integer = 0 ' Enregistrement de départ de la sélection
Private lg As Integer
Private chkfocus As Boolean = True


Private tr As TriGen
Private Col As Collection
Private CB1Conv As Collection
Private Obj As Object
Public Bsel As Boolean = False
Public Bval As String = ""
Private CB1Prev As String 

Private log As LLog 


'************************************** Gestion des articles *****************************************************
Public Sub _new(Barticle As Boolean, Bstocke As Boolean, TriArticle As String, Selection As String, Option As String, Optional Dispo As Boolean = False, Optional Mat As Boolean = False, Optional ob As Object = Null)

  Utils.Observers(Me)
  Me.Center
  Obj = ob
  If Object.IsValid(Obj) Then
    Object.SetProperty(Obj, "Bsel", False)
    Object.SetProperty(Obj, "Bval", Null)
  Endif
  CB2.Text = ""
  Org = ""
  Select Case Option
    Case "Fournisseur"
      CB2.Text = Selection
      Org = Option
    Case "Centrale"
      CB2.Text = Selection
      Org = Option
    Case "Famille"
      CB2.Text = Selection
      Org = Option
    Default
      CB2.Text = ""
      Org = ""
  End Select

  Bart = Barticle
  BStock = Bstocke
  Tri2Art = TriArticle
  If Start.LocalSettings["/Soc" & Start.Societe & "/Materiel"] = True Then
    Materiel.Value = Mat
    Materiel.Visible = True
  Else
    Materiel.Value = False
    Materiel.Visible = False
  Endif
  Disponible.Value = Dispo
  
  CB1Conv = New Collection
  CB1.Add("-- Equiv. --")
  CB1Conv.Add("art_cequ", CB1.List[0])
  CB1.Add("--  Barre --")
  CB1Conv.Add("art_cbarre", CB1.List[1])
  CB1.Add("---  CN8 ---")
  CB1Conv.Add("art_cn8", CB1.List[2])
  CB1.Add("-- Casier --")
  CB1Conv.Add("art_casier", CB1.List[3])
  CB1.Add("-- Carac. --")
  CB1Conv.Add("art_crst", CB1.List[4])
  CB1.Add("-- Four. --")
  CB1Conv.Add("art_four", CB1.List[5])

  CB1.Text = CB1.List[0]
  CB1Prev = CB1.Text
  
  Update_Req()

End

Public Sub form_Close()
  
  Utils.Log(Me, "Selection: " & Bsel & "\tVal: " & Bval, Logger.Debug)
  
End

Public Sub Update_Req()

  Dim f As ResultField
  Dim Req As String
  Dim Res As Result
  
  Col = New Collection
  
  Select Case Tri2Art
    Case "art_code"
      Req = "select *, CASE WHEN art_suspendu = 1 THEN '&HC0C0C0&' WHEN art_qte > 0 and art_stocke = 1 THEN '&H00FF00&' WHEN art_qte = 0 and art_stocke = 1 THEN '&HF8B9A0&' WHEN art_qte < 0 and art_stocke = 1 THEN '&HFF0000&' WHEN art_stocke = 0 THEN Null ELSE '&H00FFFF&' END as bgcolor from " & Cbase.Table("TabArt")
      Res = Utils.db.Exec(Req)
      If Not Res.Available Then Return
      f = Res.Fields[Tri2Art]
      Col.Add(f, "---- Code ----")
      f = Res.Fields["art_design"]
      Col.Add(f, "----------- Intitule -------------")
      f = Res.Fields[CB1Conv[CB1.Text]]
      Col.Add(f, "-" & CB1.Text & "-")
      f = Res.Fields["art_fam"]
      Col.Add(f, "- Fam. -")
      f = Res.Fields["art_pvht"]
      Col.Add(f, "- PvHT -")
      f = Res.Fields["art_pvttc"]
      Col.Add(f, "- PvTTC -")
      f = Res.Fields["art_qte"]
      Col.Add(f, "- Qte -")
    Case "mo_code"
      Req = "select * from " & Cbase.Table("TabMo")
      Res = Utils.db.Exec(Req)
      If Not Res.Available Then Return
      f = Res.Fields[Tri2Art]
      Col.Add(f, "-----code-----")
      f = Res.Fields["mo_design"]
      Col.Add(f, "-------------------intitule-------------------")
      f = Res.Fields["mo_fam"]
      Col.Add(f, "-famille-")
      f = Res.Fields["mo_valeurht"]
      Col.Add(f, "-PV HT-")
      f = Res.Fields["mo_valeurttc"]
      Col.Add(f, "-PV TTC-")
      CB1.Enabled = False
    Default
      Error.Raise("Unsupported Feature")
  End Select

  tr = New TriGen(Panel2, Col, Res, Req, 20, Me) As "ColTri"
  Filter_Calc()

End

Public Sub ColTri_MajSel(val As Variant)

  If Object.IsValid(Obj) Then
    If Bsel = True Then
      If Val Then
        Object.SetProperty(Obj, "Bsel", Bsel)
        Object.SetProperty(Obj, "Bval", Val)
      Else
        Stop Event
      Endif
    Endif
  Else
    Stop Event
  Endif
  
  Me.Close()

End

Public Sub ChkInput()

  If InStr("\"&", Key.Text) = 0 Then
    sel = utils.Obstch(sel)
  Else
    Stop Event
  Endif

End

Public Sub TriArticles_KeyPress()

  If Key.code = Key.Escape Or Key.code = Key.F2 Then
    Me.Close
  Endif

End

Public Sub _KeyPress()

  If Key.code = Key.Escape Or Key.code = Key.F2 Then
    Me.Close
  Endif

End

Public Sub Panel1_KeyPress()

  If Key.code = Key.Escape Or Key.code = Key.F2 Then
    Me.Close
  Endif

End

Public Sub Panel2_KeyPress()

  If Key.code = Key.Escape Or Key.code = Key.F2 Then
    Me.Close
  Endif

End

'***************************************************************
'* On appelle la liste des fournisseurs  ou des familles       *
'***************************************************************
Public Sub FourMan()

  Dim Rfour As Result

  Rfour = Utils.db.Exec("SELECT fo_nom FROM " & Cbase.Table("TabFour") & " where fo_code = &1", CB2.Text)
  If Rfour.Available Then
    Fnom.Text = Rfour!fo_nom
  Else
    Message.Warning("Attention ! Ce fournisseur n'existe pas.")
  Endif

End

Public Sub Button1_Click()

  Dim Rfour As Result
  Dim Rfam As Result
  Dim Rcentrale As Result

  If Org = "Fournisseur" Then
    If Colist.visible Then
      Colist.clear
      Colist.visible = False
    Else
      Colist.visible = True
      Colist.Raise
      Colist.Columns.count = 2
      Colist.Columns[0].Width = 65
      Colist.Columns[1].Width = 180
      Colist.Columns[0].Text = "code"
      Colist.Columns[1].Text = "Intitulé"
      Rfour = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabFour") & " ")
      If Rfour.Available Then
        Do
          Colist.Add(Rfour!fo_code, Rfour!fo_code)
          Colist.Item[0] = Rfour!fo_code
          Colist.Item[1] = Rfour!fo_nom
        Loop Until Rfour.MoveNext()
        Colist.MoveFirst
        Colist.SetFocus
        Colist.Item.Selected = True
      Endif
    Endif
  Endif
  If Org = "Famille" Then
    If Colist.visible Then
      Colist.clear
      Colist.visible = False
    Else
      Colist.visible = True
      Colist.Raise
      Colist.Columns.count = 2
      Colist.Columns[0].Width = 65
      Colist.Columns[1].Width = 180
      Colist.Columns[0].Text = "code"
      Colist.Columns[1].Text = "Intitulé"
      Rfam = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabFam") & " ")
      If Rfam.Available Then
        Do
          Colist.Add(Rfam!code_fam, Rfam!code_fam)
          Colist.Item[0] = Rfam!code_fam
          Colist.Item[1] = Rfam!libell_fam
        Loop Until Rfam.MoveNext()
        Colist.MoveFirst
        Colist.SetFocus
        Colist.Item.Selected = True
      Endif
    Endif
  Endif
  If Org = "Centrale" Then
    If Colist.visible Then
      Colist.clear
      Colist.visible = False
    Else
      Colist.visible = True
      Colist.Raise
      Colist.Columns.count = 2
      Colist.Columns[0].Width = 65
      Colist.Columns[1].Width = 180
      Colist.Columns[0].Text = "code"
      Colist.Columns[1].Text = "Intitulé"
      Rcentrale = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabCentrales") & " ")
      If Rcentrale.Available Then
        Do
          Colist.Add(Rcentrale!code, Rcentrale!code)
          Colist.Item[0] = Rcentrale!code
          Colist.Item[1] = Rcentrale!libelle
        Loop Until Rcentrale.MoveNext()
        Colist.MoveFirst
        Colist.SetFocus
        Colist.Item.Selected = True
      Endif
    Endif
  Endif

End

'**************************************************
'* Selection d'un fournisseur a la souris         *
'**************************************************
Public Sub Colist_Click()

  CB2.text = Colist.Item[0]
  Fnom.text = Colist.Item[1]
  Colist.clear
  Colist.visible = False
  Filter_Calc()
  tr.Update()

End

'***********************************************************
'* Selection d'un fournisseur/famille manuellement         *
'***********************************************************
Public Sub Colist_KeyPress()

  If Key.code = Key.Enter Or Key.code = Key.Return Then
    Colist_Click()
  Endif

  If Key.code = Key.Escape Or Key.code = Key.F2 Then
    Colist.visible = False
    Colist.clear
    Stop Event
  Endif

End

Public Sub CB2_KeyPress()

  If Key.code = Key.Escape Or Key.code = Key.F2 Then Me.close()

End

Public Sub CB2_GotFocus()

  Try Utils.ObsGotf(Cb2)

End

Public Sub CB2_LostFocus()

  Dim CoulZns As Integer ' Variable pour la couleur du background des zones de saisie
  Dim Frmt As New String[]

  Frmt = Utils.FColr(Start.LocalSettings["/Coul/Znss"])
  CoulZns = Val(Frmt[0])
  CB2.Background = CoulZns

End

Public Sub CB1_Click()

  Update_Req()

End

Public Sub CB2_Click()

  CB2.SetFocus
  CB2.Select
  Org = CB2.text
  Button1_Click()

End

Public Sub Filter_Calc()
  
  Dim filter As String

  filter = ""
  
  Select Case Org
    Case "Fournisseur"
      If CB2.Text Then filter &= "art_four = \"" & CB2.Text & "\""
    Case "Famille"
      If CB2.Text Then filter &= "art_fam = \"" & CB2.Text & "\""
    Case "Centrale"
      If CB2.Text Then filter &= "art_centrale = \"" & CB2.Text & "\""
    Default
      Org = ""
      filter = ""
  End Select
  
  Select Case Tri2Art
    Case "art_code"
      If BStock Then
        If filter <> "" Then
          filter &= " and "
        Endif
        filter &= "art_stocke = 1 "
      Endif
      If Disponible.Value Then
        If filter <> "" Then
          filter &= " and "
        Endif
        If BStock Then
          filter &= "art_qte > 0 "
        Else
          filter &= "( ( art_stocke = 0 and art_qte = 0 ) or art_qte > 0 ) "
        Endif
      Endif
      If Materiel.Value Then
        If filter <> "" Then
          filter &= " and "
        Endif
        filter &= "art_mat = 1"
      Endif
    Default
      filter = ""
  End Select
  
  If filter <> "" Then
    tr.ExtraSel(filter, "and")
  Else
    tr.ExtraSel(filter, "")
  Endif

End


Public Sub Materiel_Click()

  Filter_Calc()
  tr.Update()

End

Public Sub Disponible_Click()

  Filter_Calc()
  tr.Update()

End
