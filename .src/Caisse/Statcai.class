' Gambas class file

'----------------------------------------------------------------------------
'

'
'Ce programme est un logiciel libre; Vous pouvez le redistribuer et/ou
'le modifier selon les termes de la GNU General PUBLIC License publiés par
'la Free Software Foundation.

'Ce programme est distribué sans garantie. Voyez la GNU General PUBLIC
'License pour plus de details.

'Vous devez lire la GNU General PUBLIC Licence.
'Si vous ne disposez pas d'un exemplaire, veuillez écrire
'à " The Free Software Foundation
'INC, 59 Temple place - Suite 33, Boston
'MA 02111-1307 USA
'----------------------------------------------------------------------------
'################################################
'# nom du fichier           : StatCai.class
'# Auteur                   : Jacky Tripoteau
'# date de création         : 03/12/2009
'# Visu du CA horaire de la caisse
'################################################

Private Tot As Integer
Private son As Integer = Start.Son

Public Sub _New()

  Utils.Observers(Me)
  Tot = 20

  With Liste
    .Columns.count = 13
    .Columns[0].Alignment = 3
    .Columns[0].Width = TextBox1.Width
    .Columns[1].Alignment = 3
    .Columns[1].Width = TextBox2.Width
    .Columns[2].Alignment = 3
    .Columns[2].Width = TextBox3.Width
    .Columns[3].Alignment = 3
    .Columns[3].Width = TextBox4.Width
    .Columns[4].Alignment = 3
    .Columns[4].Width = TextBox5.Width
    .Columns[5].Alignment = 3
    .Columns[5].Width = TextBox6.Width
    .Columns[6].Alignment = 3
    .Columns[6].Width = TextBox7.Width
    .Columns[7].Alignment = 3
    .Columns[7].Width = TextBox8.Width
    .Columns[8].Alignment = 3
    .Columns[8].Width = TextBox9.Width
    .Columns[9].Alignment = 3
    .Columns[9].Width = TextBox10.Width
    .Columns[10].Alignment = 3
    .Columns[10].Width = TextBox11.Width
    .Columns[11].Alignment = 3
    .Columns[11].Width = TextBox12.Width
    .Columns[12].Alignment = 3
    .Columns[12].Width = TextBox13.Width
  End With
  
  DateBox1.Value = Now

End

Public Sub Btn_Click()

  Select Case Last.tag

    Case 1
      Recup_ca()
      Traitement()

    Case 2
      Me.Close
  End Select

End

Public Sub Recup_ca()

  Dim rResult As Result
  Dim rCai As Result
  Dim rTot As Result
  Dim Tab As String
  Dim Tab2, Tab3 As String
  Dim Totl As Float = 0
  Dim Ncaisse As String
  Dim heure As Integer

  Tab = "Total"
  ' on efface le fichier des totalisations
  Utils.db.Exec("drop Table IF exists " & Tab & "")
  ' puis on recréé
  Utils.db.EXEC("CREATE TABLE " & Tab &
    "(heure int NOT NULL," &
    "ca decimal(12,2)," &
    "ncai Char(2)," &
    "PRIMARY KEY (heure, ncai))" & Utils.db.Engine())
  rResult = Utils.db.Exec("SELECT * FROM " & Cbase.Table("TabCaisses") & " order by code ")
  If rResult.Available Then
    Repeat
      Ncaisse = rResult!code
      Tab2 = "Fiches_EntTicketz"
      Tab3 = "Fiches_HisEntTickets" 
      rCai = Utils.db.Exec("SELECT sum(cast(REPLACE(mht,',','.') as decimal(11,2))) as ca, HOUR(date) as heure FROM " & Tab2 & " where caisse = &1 and statut IN(&2) and date BETWEEN &3 AND &4 and suppr != 1 group by HOUR(date) union SELECT sum(cast(REPLACE(mht,',','.') as decimal(11,2))) as ca, HOUR(date) as heure FROM " & Tab3 & " where caisse = &1 and date BETWEEN &3 AND &4 and suppr != 1 group by HOUR(date)", Ncaisse, "\"V\",\"0\"", LDate(DateBox1.Value).DT, LDate(DateBox1.Value).FinJour.DT)
      If rCai.Available Then
        Repeat
          heure = rCai!heure
          If heure < 8 Then
            heure = 8 
          Else
            If heure > 19 Then heure = 19
          Endif
          rTot = Utils.db.Exec("SELECT * FROM " & Tab & " where ncai = &1 and heure = &2", Ncaisse, heure)
          If rTot.Available Then
            Totl = rTot!ca + Val(Utils.cpoint(rCai!ca))
            Utils.db.Exec("UPDATE  " & Tab & "  SET ca = &2 WHERE ncai = &1 and heure = &3", Ncaisse, Totl, heure)
          Else
            Utils.db.Exec("INSERT INTO " & Tab & "(heure, ca, ncai) VALUES (&1, &2, &3)", heure, Val(Utils.cpoint(rCai!ca)), Ncaisse)
          Endif
          Totl = 0
        Until rCai.MoveNext()
      Endif
    Until rResult.MoveNext()
  Else
    Message.Warning("Aucune donnée à traiter !")
  Endif
Catch
  If son Then
    Music.Play
  Endif
  Message.Info(" Il y a un problème sur une ligne de CA ! Traitement interrompu.")

End

Public Sub Traitement()

  Dim Tab As String
  Dim rResult As Result
  Dim Totl As Float = 0
  Dim Vah As String
  Dim Ncaisse As String

  Tab = "Total"
  rResult = Utils.db.Exec("SELECT * FROM " & Tab & " order by ncai, heure ")
  With Liste
    .Clear
    If rResult.Available Then
      .Add(rResult!ncai & rResult!heure, rResult!ncai)
      Ncaisse = rResult!ncai
      Repeat
        If rResult!ncai <> Ncaisse Then .Add(rResult!ncai & rResult!heure, rResult!ncai)
        Vah = Format$(rResult!ca, "0.00")
        If IsNull(vah) Then Vah = " "
        
        Select Case rResult!heure
          Case 8
            .Item[1] = Vah
          Case 9
            .Item[2] = Vah
          Case 10
            .Item[3] = Vah
          Case 11
            .Item[4] = Vah
          Case 12
            .Item[5] = Vah
          Case 13
            .Item[6] = Vah
          Case 14
            .Item[7] = Vah
          Case 15
            .Item[8] = Vah
          Case 16
            .Item[9] = Vah
          Case 17
            .Item[10] = Vah
          Case 18
            .Item[11] = Vah
          Case 19
            .Item[12] = Vah
        End Select
        Totl = Totl + Val(Utils.cpoint(vah))
        Ncaisse = rResult!ncai
      Until rResult.MoveNext()
      Totc.Text = Format$(Totl, "0.00")
    Endif
  End With

End
